int __cdecl shellcode(int a1)
{
  int result; // eax
  int encrypted_string_size; // ecx
  int encrypted_string; // edi
  int index; // edx
  char a_fopen[6]; // [esp+4h] [ebp-1B8h]
  char v6; // [esp+Ch] [ebp-1B0h]
  void (__cdecl *fseek)(int, signed int, _DWORD); // [esp+118h] [ebp-A4h]
  char a_k32[22]; // [esp+11Ch] [ebp-A0h]
  int h_k32; // [esp+138h] [ebp-84h]
  int (__cdecl *fopen)(char *, char *); // [esp+13Ch] [ebp-80h]
  char a_rb[3]; // [esp+140h] [ebp-7Ch]
  char a_GetModuleFileNameA[20]; // [esp+144h] [ebp-78h]
  int (__cdecl *fclose)(int); // [esp+158h] [ebp-64h]
  char a_fclose[7]; // [esp+15Ch] [ebp-60h]
  char a_msvcrt[11]; // [esp+164h] [ebp-58h]
  char a_fread[6]; // [esp+170h] [ebp-4Ch]
  int (__stdcall *GetProcAddress)(int, char *); // [esp+178h] [ebp-44h]
  int file; // [esp+17Ch] [ebp-40h]
  int h_msvcrt; // [esp+180h] [ebp-3Ch]
  char key[40]; // [esp+184h] [ebp-38h]
  void (__stdcall *GetModuleFileNameA)(_DWORD, char *, signed int); // [esp+1ACh] [ebp-10h]
  char a_fseek[6]; // [esp+1B0h] [ebp-Ch]
  int (__stdcall *LoadLibraryA)(char *); // [esp+1B8h] [ebp-4h]

  a_msvcrt[0] = 'm';
  a_msvcrt[1] = 's';
  a_msvcrt[2] = 'v';
  a_msvcrt[3] = 'c';
  a_msvcrt[4] = 'r';
  a_msvcrt[5] = 't';
  a_msvcrt[6] = '.';
  a_msvcrt[7] = 'd';
  a_msvcrt[8] = 'l';
  a_msvcrt[9] = 'l';
  a_msvcrt[10] = 0;
  a_k32[0] = 'k';
  a_k32[1] = 'e';
  a_k32[2] = 'r';
  a_k32[3] = 'n';
  a_k32[4] = 'e';
  a_k32[5] = 'l';
  a_k32[6] = '3';
  a_k32[7] = '2';
  a_k32[8] = '.';
  a_k32[9] = 'd';
  a_k32[10] = 'l';
  a_k32[11] = 'l';
  a_k32[12] = 0;
  a_fopen[0] = 'f';
  a_fopen[1] = 'o';
  a_fopen[2] = 'p';
  a_fopen[3] = 'e';
  a_fopen[4] = 'n';
  a_fopen[5] = '\0';
  a_fread[0] = 'f';
  a_fread[1] = 'r';
  a_fread[2] = 'e';
  a_fread[3] = 'a';
  a_fread[4] = 'd';
  a_fread[5] = '\0';
  a_fseek[0] = 'f';
  a_fseek[1] = 's';
  a_fseek[2] = 'e';
  a_fseek[3] = 'e';
  a_fseek[4] = 'k';
  a_fseek[5] = '\0';
  a_fclose[0] = 'f';
  a_fclose[1] = 'c';
  a_fclose[2] = 'l';
  a_fclose[3] = 'o';
  a_fclose[4] = 's';
  a_fclose[5] = 'e';
  a_fclose[6] = '\0';
  a_GetModuleFileNameA[0] = 'G';
  a_GetModuleFileNameA[1] = 'e';
  a_GetModuleFileNameA[2] = 't';
  a_GetModuleFileNameA[3] = 'M';
  a_GetModuleFileNameA[4] = 'o';
  a_GetModuleFileNameA[5] = 'd';
  a_GetModuleFileNameA[6] = 'u';
  a_GetModuleFileNameA[7] = 'l';
  a_GetModuleFileNameA[8] = 'e';
  a_GetModuleFileNameA[9] = 'F';
  a_GetModuleFileNameA[10] = 'i';
  a_GetModuleFileNameA[11] = 'l';
  a_GetModuleFileNameA[12] = 'e';
  a_GetModuleFileNameA[13] = 'N';
  a_GetModuleFileNameA[14] = 'a';
  a_GetModuleFileNameA[15] = 'm';
  a_GetModuleFileNameA[16] = 'e';
  a_GetModuleFileNameA[17] = 'A';
  a_GetModuleFileNameA[18] = '\0';
  a_rb[0] = 'r';
  a_rb[1] = 'b';
  a_rb[2] = 0;
  LoadLibraryA = *a1;
  GetProcAddress = *(a1 + 4);
  h_msvcrt = LoadLibraryA(a_msvcrt);
  h_k32 = LoadLibraryA(a_k32);
  GetModuleFileNameA = GetProcAddress(h_k32, a_GetModuleFileNameA);
  fopen = GetProcAddress(h_msvcrt, a_fopen);
  fseek = GetProcAddress(h_msvcrt, a_fseek);
  *&a_k32[16] = GetProcAddress(h_msvcrt, a_fread);
  fclose = GetProcAddress(h_msvcrt, a_fclose);
  GetModuleFileNameA(0, &v6, 260);
  file = fopen(&v6, a_rb);
  fseek(file, 0x4E, 0);                         // jumps to "This program bla bla" text from PE header
  (*&a_k32[16])(key, 38, 1, file);              // fread, reads 38 bytes string (This program cannot be run in DOS mode)
  result = fclose(file);
  encrypted_string_size = *(a1 + 12);
  encrypted_string = *(a1 + 8);
  index = 0;
  do
  {
    LOBYTE(result) = key[index];
    *(encrypted_string + index++) ^= result;
  }
  while ( index != encrypted_string_size );
  return result;
}